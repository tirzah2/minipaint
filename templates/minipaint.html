<div class="minipaint-app">
  <iframe id="myFrame" style="width:100%; border:0;" src="modules/minipaint/index.html" allow="camera"></iframe>

  </div>
</div>

<script>
// Function to hide specific elements in the iframe
function hideElementsInIframe() {
  const iframe = document.getElementById('myFrame');
  
  // Check if iframe and its content are accessible
  if (iframe && iframe.contentWindow) {
    const iframeDocument = iframe.contentWindow.document;

    // Use querySelector to find the specific elements by their selectors
    const helpMenuItem = iframeDocument.querySelector('#main_menu_0_7');
    const logoElement = iframeDocument.querySelector('a.logo');

    // Hide the help menu item if found
    if (helpMenuItem) {
      helpMenuItem.style.display = 'none';
    }

    // Hide the logo element if found
    if (logoElement) {
      logoElement.style.display = 'none';
    }
  }
}

// Attach an event listener to the iframe to run the function once it's loaded
document.getElementById('myFrame').addEventListener('load', hideElementsInIframe);

// Function to inject the Load Tile and Replace Tile menu items into the menu bar
function injectMenuItems() {
  const iframe = document.getElementById('myFrame');

  // Check if iframe and its content are accessible
  if (iframe && iframe.contentWindow) {
    const iframeDocument = iframe.contentWindow.document;

    // test

    const fileMenu = iframeDocument.querySelector('#main_menu_0_0');
    const imageMenu = iframeDocument.querySelector('#main_menu_0_3'); // Adjust ID if necessary

if (imageMenu) {
  // Wait until the Image dropdown is clicked to expand the items
  imageMenu.addEventListener('click', () => {
    const infoMenuItem = iframeDocument.querySelector('#main_menu_1_0'); // Adjust the ID if necessary to target "Information ..."

    if (infoMenuItem) {
      // Create the Pop! menu item
      const popMenuItem = iframeDocument.createElement('a');
      popMenuItem.id = "main_menu_pop";
      popMenuItem.role = "menuitem";
      popMenuItem.tabindex = "-1";
      popMenuItem.ariaHaspopup = "false";
      popMenuItem.href = "javascript:void(0)";
      popMenuItem.target = "_self";
      popMenuItem.dataset.level = "70";
      popMenuItem.dataset.index = "pop";
      popMenuItem.innerHTML = `
        <span class="name">Show Players</span>
      `;
      popMenuItem.onclick = () => window.parent.showCanvasInImagePopout();

      // Insert the Pop! menu item above the "Information ..." item
      infoMenuItem.parentNode.insertBefore(popMenuItem, infoMenuItem);
    }
  });
}



if (fileMenu) {
  // Wait until the File dropdown is clicked to expand the items
  fileMenu.addEventListener('click', () => {
    const saveAsMenuItem = iframeDocument.querySelector('#main_menu_1_6');
    const newMenuItem = iframeDocument.querySelector('#main_menu_1_0');

const mainMenuLeft = parseFloat(window.getComputedStyle(fileMenu).left); // Get the left style as a number
const adjustedLeft = mainMenuLeft - 151.854;
    if (saveAsMenuItem && newMenuItem) {
      // Create New Token menu item
      const newTokenMenuItem = iframeDocument.createElement('a');
      newTokenMenuItem.id = "main_menu_new_token";
      newTokenMenuItem.role = "menuitem";
      newTokenMenuItem.tabindex = "-1";
      newTokenMenuItem.ariaHaspopup = "false";
      newTokenMenuItem.href = "javascript:void(0)";
      newTokenMenuItem.target = "_self";
      newTokenMenuItem.dataset.level = "70";
      newTokenMenuItem.dataset.index = "5";
      newTokenMenuItem.innerHTML = `
        <span class="name">New Simple Token</span>
      `;
      newTokenMenuItem.onclick = () => window.parent.open_tokenframe();


      const saveAsRingMenuItem = iframeDocument.createElement('a');
          saveAsRingMenuItem.id = "main_menu_save_as_ring";
          saveAsRingMenuItem.role = "menuitem";
          saveAsRingMenuItem.tabindex = "-1";
          saveAsRingMenuItem.ariaHaspopup = "false";
          saveAsRingMenuItem.href = "javascript:void(0)";
          saveAsRingMenuItem.target = "_self";
          saveAsRingMenuItem.dataset.level = "72";
          saveAsRingMenuItem.dataset.index = "7";
          saveAsRingMenuItem.innerHTML = `
            <span class="name">Save as Frame</span>
          `;
          saveAsRingMenuItem.onclick = () => saveCanvasToFrames();


      const ringsBrowserMenuItem = iframeDocument.createElement('a');
          ringsBrowserMenuItem.id = "main_menu_rings_browser";
          ringsBrowserMenuItem.role = "menuitem";
          ringsBrowserMenuItem.tabindex = "-1";
          ringsBrowserMenuItem.ariaHaspopup = "false";
          ringsBrowserMenuItem.href = "javascript:void(0)";
          ringsBrowserMenuItem.target = "_self";
          ringsBrowserMenuItem.dataset.level = "71";
          ringsBrowserMenuItem.dataset.index = "10";
          ringsBrowserMenuItem.innerHTML = `
            <span class="name">Frame Browser</span>
          `;
          ringsBrowserMenuItem.onclick = () => galleryMP.render(true);
      // Create Save Token menu item
      const saveTokenMenuItem = iframeDocument.createElement('a');
      saveTokenMenuItem.id = "main_menu_save_proto";
      saveTokenMenuItem.role = "menuitem";
      saveTokenMenuItem.tabindex = "-1";
      saveTokenMenuItem.ariaHaspopup = "false";
      saveTokenMenuItem.href = "javascript:void(0)";
      saveTokenMenuItem.target = "_self";
      saveTokenMenuItem.dataset.level = "1";
      saveTokenMenuItem.dataset.index = "10";
      saveTokenMenuItem.innerHTML = `
        <span class="name">Save Token</span>
      `;
      saveTokenMenuItem.onclick = () => window.parent.replaceActorTexture('prototypeToken');

      // Create Save Portrait menu item
      const savePortraitMenuItem = iframeDocument.createElement('a');
      savePortraitMenuItem.id = "main_menu_save_actor_image";
      savePortraitMenuItem.role = "menuitem";
      savePortraitMenuItem.tabindex = "-1";
      savePortraitMenuItem.ariaHaspopup = "false";
      savePortraitMenuItem.href = "javascript:void(0)";
      savePortraitMenuItem.target = "_self";
      savePortraitMenuItem.dataset.level = "1";
      savePortraitMenuItem.dataset.index = "10";
      savePortraitMenuItem.innerHTML = `
        <span class="name">Save Portrait</span>
      `;
      savePortraitMenuItem.onclick = () => window.parent.replaceActorTexture('img');

      // Create Save Item menu item
      const saveItemMenuItem = iframeDocument.createElement('a');
      saveItemMenuItem.id = "main_menu_save_item_image";
      saveItemMenuItem.role = "menuitem";
      saveItemMenuItem.tabindex = "-1";
      saveItemMenuItem.ariaHaspopup = "false";
      saveItemMenuItem.href = "javascript:void(0)";
      saveItemMenuItem.target = "_self";
      saveItemMenuItem.dataset.level = "1";
      saveItemMenuItem.dataset.index = "70";
      saveItemMenuItem.innerHTML = `
        <span class="name">Save Item</span>
      `;
      saveItemMenuItem.onclick = () => window.parent.replaceItemTexture();

      //test
      const newFrameMenuItem = iframeDocument.createElement('a');
      newFrameMenuItem.id = "main_menu_new_frame";
      newFrameMenuItem.role = "menuitem";
      newFrameMenuItem.tabindex = "-1";
      newFrameMenuItem.ariaHaspopup = "true";
      newFrameMenuItem.ariaExpanded = "false";
      newFrameMenuItem.href = "javascript:void(0)";
      newFrameMenuItem.target = "_self";
      newFrameMenuItem.dataset.level = "71";
      newFrameMenuItem.dataset.index = "6";
      newFrameMenuItem.innerHTML = `
        <span class="name"><- Templates</span>
      `;

      // Create the submenu (dropdown) for the New Frame options
      const subMenu = iframeDocument.createElement('ul');
      subMenu.className = 'menu_dropdown';
      subMenu.role = 'menu';
      subMenu.style.display = 'none'; // Hidden by default
      subMenu.style.position = 'absolute';
      subMenu.style.zIndex = '1000';
      subMenu.style.left = `221px`; // Adjusted left position
      subMenu.style.top = '30px'; // Adjusted top position

      // Create Frame 1, Frame 2, and Frame 3 menu items
      ['Frame 1', 'Frame 2', 'Frame 3','Token 1'].forEach((frame, index) => {
  const frameItem = iframeDocument.createElement('li');
  frameItem.innerHTML = `
    <a href="javascript:void(0)" role="menuitem" tabindex="-1" data-index="frame_${index + 1}">
      ${frame}
    </a>
  `;

  // Attach the click event listener to each frame item
  frameItem.onclick = () => {
    switch (index) {
      case 0:
        window.parent.openFrame1();
        break;
      case 1:
        window.parent.openFrame2();
        break;
      case 2:
        window.parent.openFrame3();
        break;
      case 3:
        window.parent.openFrame4();
        break;
    }
    subMenu.style.display = 'none';
    newFrameMenuItem.ariaExpanded = 'false';
  };

  // Append frame item to the submenu
  subMenu.appendChild(frameItem);
});

      // Toggle submenu visibility on click
      newFrameMenuItem.onclick = (e) => {
        e.stopPropagation(); // Prevent the click event from bubbling up
        const isVisible = subMenu.style.display === 'block';
        subMenu.style.display = isVisible ? 'none' : 'block';
        newFrameMenuItem.ariaExpanded = !isVisible;
      };

      // Hide the submenu if clicking outside
      iframeDocument.addEventListener('click', (e) => {
        if (subMenu.style.display === 'block' && !subMenu.contains(e.target)) {
          subMenu.style.display = 'none';
          newFrameMenuItem.ariaExpanded = 'false';
        }
      });

      // Insert the New Frame menu item above the "New" item
      newMenuItem.parentNode.insertBefore(newFrameMenuItem, newMenuItem);

      // Insert the submenu inside the "Main Menu" structure
      const mainMenu = iframeDocument.querySelector('.main_menu');
      if (mainMenu) {
        mainMenu.appendChild(subMenu);
      }
      const templateMenuItem = iframeDocument.querySelector('#main_menu_new_frame');
      templateMenuItem.parentNode.insertBefore(saveAsRingMenuItem, templateMenuItem.nextSibling);
      // Insert the New Simple Token menu item above the "New" item
      newMenuItem.parentNode.insertBefore(newTokenMenuItem, newFrameMenuItem);
      newMenuItem.parentNode.insertBefore(ringsBrowserMenuItem, newTokenMenuItem.nextSibling);
      // Insert the new menu items above the "Save As" item
      saveAsMenuItem.parentNode.insertBefore(savePortraitMenuItem, saveAsMenuItem);
      if (!window.parent.minipaintItem) {
  saveItemMenuItem.style.display = 'none';
} else {
  saveItemMenuItem.style.display = 'block'; 
  saveItemMenuItem.style.backgroundColor = 'darkgreen';
  saveItemMenuItem.style.border = '3px solid lightgreen';
  saveItemMenuItem.style.color = 'lightgreen';
}
      if (window.parent.tidyType === 'img') {
    savePortraitMenuItem.style.backgroundColor = 'darkgreen';
    savePortraitMenuItem.style.border = '3px solid lightgreen';
    savePortraitMenuItem.style.color = 'lightgreen';
    //saveTokenMenuItem.style.display = 'none'; // Hide Save Token button
} else if (window.parent.tidyType === 'prototypeToken') {
    saveTokenMenuItem.style.backgroundColor = 'darkgreen';
    saveTokenMenuItem.style.border = '3px solid lightgreen';
    saveTokenMenuItem.style.color = 'lightgreen';
    //savePortraitMenuItem.style.display = 'none'; // Hide Save Portrait button
} else {
    // Hide both buttons if tidyType is null, undefined, or any other value
    saveTokenMenuItem.style.display = 'none';
    savePortraitMenuItem.style.display = 'none';
}
      saveAsMenuItem.parentNode.insertBefore(saveTokenMenuItem, savePortraitMenuItem);
      saveAsMenuItem.parentNode.insertBefore(saveItemMenuItem, saveTokenMenuItem);
    }
  });
}


   const menuBar = iframeDocument.querySelector('.menu_bar');

   if (menuBar) {
      // Create Load Selected menu item
      const loadSelectedMenuItem = iframeDocument.createElement('li');
      loadSelectedMenuItem.innerHTML = `
        <a id="main_menu_load_selected" role="menuitem" tabindex="-1" aria-haspopup="false" aria-expanded="false" href="javascript:void(0)" data-level="0" onclick="window.parent.loadSelected()" title="Load the selected token or tile into miniPaint">
          Load Selected
        </a>
      `;

      // Create Replace Selected menu item
      const replaceSelectedMenuItem = iframeDocument.createElement('li');
      replaceSelectedMenuItem.innerHTML = `
        <a id="main_menu_replace_selected" role="menuitem" tabindex="-1" aria-haspopup="false" aria-expanded="false" href="javascript:void(0)" data-level="0" onclick="window.parent.replaceSelected()" title="Replace the selected token or tile with the edited image">
          Replace Selected
        </a>
      `;

      // Browse Foundry Menu Item
      const loadBrowseMenuItem = iframeDocument.createElement('li');
      loadBrowseMenuItem.innerHTML = `
        <a id="main_menu_browse_foundry" role="menuitem" tabindex="-1" aria-haspopup="false" aria-expanded="false" href="javascript:void(0)" data-level="0" onclick="window.parent.browseFoundry()" title="Open the Foundry file picker to import an image">
          <i class="fas fa-folder-open"></i> Foundry
        </a>
      `;

      // Save Foundry Menu Item
      const saveFoundryMenuItem = iframeDocument.createElement('li');
      saveFoundryMenuItem.innerHTML = `
        <a id="main_menu_save_foundry" role="menuitem" tabindex="-1" aria-haspopup="false" aria-expanded="false" href="javascript:void(0)" data-level="0" onclick="window.parent.saveFoundry()" title="Save the edited image back to Foundry">
         <i class="fas fa-save"></i> Foundry
        </a>
      `;

      // Insert menu items into the menu bar in the correct order
      menuBar.insertBefore(loadSelectedMenuItem, menuBar.firstChild);
      menuBar.insertBefore(replaceSelectedMenuItem, loadSelectedMenuItem.nextSibling);
      menuBar.insertBefore(loadBrowseMenuItem, replaceSelectedMenuItem.nextSibling);
      menuBar.insertBefore(saveFoundryMenuItem, loadBrowseMenuItem.nextSibling);
    }


  }
}

// Attach an event listener to the iframe to run the function once it's loaded
document.getElementById('myFrame').addEventListener('load', injectMenuItems);

function createStyledButton(iframeDocument, text, clickHandler) {
  const buttonDiv = iframeDocument.createElement('div');
  buttonDiv.style.width = '65px';
  buttonDiv.style.height = '25px';
  buttonDiv.style.backgroundColor = 'transparent';
  buttonDiv.style.position = 'relative';
  buttonDiv.style.display = 'flex';
  buttonDiv.style.justifyContent = 'center';
  buttonDiv.style.alignItems = 'center';
  buttonDiv.style.marginTop = '5px';
  buttonDiv.style.marginLeft = '5px';
  buttonDiv.style.cursor = 'pointer';
  buttonDiv.style.border = '1px solid #ccc';

  const buttonText = iframeDocument.createElement('span');
  buttonText.textContent = text;
  buttonText.style.color = '#FFFFFF';
  buttonText.style.fontSize = '12px';
  buttonText.style.fontWeight = 'bold';
  buttonText.style.cursor = 'pointer';
  buttonText.style.pointerEvents = 'none';

  buttonDiv.appendChild(buttonText);
  buttonDiv.onclick = clickHandler;

  return buttonDiv;
}
// Function to create a new button with shared styles
function createStyledButton(iframeDocument, text, action) {
  const buttonDiv = iframeDocument.createElement('div');
  buttonDiv.style.width = '65px';
  buttonDiv.style.height = '25px';
  buttonDiv.style.backgroundColor = '#464d4f';
  buttonDiv.style.position = 'relative';
  buttonDiv.style.display = 'flex';
  buttonDiv.style.justifyContent = 'center';
  buttonDiv.style.alignItems = 'center';
  buttonDiv.style.marginTop = '5px';
  buttonDiv.style.marginLeft = '5px';
  buttonDiv.style.cursor = 'pointer';
  buttonDiv.style.border = '1px solid #ccc'; // Optional border for visibility

  const buttonText = iframeDocument.createElement('span');
  buttonText.textContent = text;
  buttonText.style.color = '#FFFFFF';
  buttonText.style.fontSize = '12px';
  buttonText.style.fontWeight = 'bold';
  buttonText.style.cursor = 'pointer';
  buttonText.style.pointerEvents = 'none'; // Prevent text from blocking clicks

  buttonDiv.appendChild(buttonText);
  buttonDiv.onclick = action;

  return buttonDiv;
}

// Function to replace the element in the iframe
function replaceElementInIframe() {
  const iframe = document.getElementById('myFrame');

  if (iframe && iframe.contentWindow) {
    const iframeDocument = iframe.contentWindow.document;

    const animationElement = iframeDocument.querySelector('#animation');

    if (animationElement) {
      // Create label divs
      const bgLabel = iframeDocument.createElement('div');
      bgLabel.style.width = '65px';
      bgLabel.style.height = '11px';
      bgLabel.style.backgroundColor = 'transparent';
      bgLabel.style.position = 'relative';
      bgLabel.style.display = 'flex';
      bgLabel.style.justifyContent = 'center';
      bgLabel.style.alignItems = 'center';
      bgLabel.style.marginTop = '5px';
      bgLabel.style.marginLeft = '5px';
      bgLabel.textContent = 'BgRemove';

      const sketchLabel = iframeDocument.createElement('div');
      sketchLabel.style.width = '65px';
      sketchLabel.style.height = '11px';
      sketchLabel.style.backgroundColor = 'transparent';
      sketchLabel.style.position = 'relative';
      sketchLabel.style.display = 'flex';
      sketchLabel.style.justifyContent = 'center';
      sketchLabel.style.alignItems = 'center';
      sketchLabel.style.marginTop = '5px';
      sketchLabel.style.marginLeft = '5px';
      sketchLabel.textContent = 'StabilityAI';

      // Create the "BG" button using the reusable function
      const bgButton = createStyledButton(iframeDocument, 'BG', () => {
  window.parent.removeBackgroundAndAddLayer();
});
bgButton.title = "Remove the background of the image using removeBG.";

const sketchButton = createStyledButton(iframeDocument, 'Sketch', () => {
  window.parent.applySketchEffect();
});
sketchButton.title = "Transform your sketch into a real image using Stability AI.";

const bgRemoveButton = createStyledButton(iframeDocument, 'BG', () => {
  window.parent.removeBackgroundUsingStabilityAI();
});
bgRemoveButton.title = "Remove the background using Stability AI's API.";

const srButton = createStyledButton(iframeDocument, 'S&R', () => {
  window.parent.searchAndReplace();
});
srButton.title = "Search and replace specific elements in the image using Stability AI.";

const genRing = createStyledButton(iframeDocument, 'GenRing', () => {
  window.parent.applyInpaintRing();
});
genRing.title = "Generate a token ring replacing the transparent area.";

const genToken = createStyledButton(iframeDocument, 'GenToken', () => {
  window.parent.applyInpaintToken();
});
genToken.title = "Generate and apply a token inside of the transparent area.";

      // Insert the labels and buttons into the DOM in the correct order
      animationElement.parentNode.replaceChild(bgLabel, animationElement);
      bgLabel.parentNode.insertBefore(bgButton, bgLabel.nextSibling);
      bgButton.parentNode.insertBefore(sketchLabel, bgButton.nextSibling);
      sketchLabel.parentNode.insertBefore(sketchButton, sketchLabel.nextSibling);
      sketchButton.parentNode.insertBefore(bgRemoveButton, sketchButton.nextSibling);
      sketchButton.parentNode.insertBefore(srButton, sketchButton.nextSibling);
      srButton.parentNode.insertBefore(genRing, sketchButton.nextSibling);
      genRing.parentNode.insertBefore(genToken, sketchButton.nextSibling);
    }
  }
}

// Attach an event listener to the iframe to run the function once it's loaded
document.getElementById('myFrame').addEventListener('load', replaceElementInIframe);


function attachDropEventListener() {
    const iframe = document.getElementById('myFrame');

    if (iframe && iframe.contentWindow) {
        iframe.contentWindow.document.addEventListener('drop', async function(event) {
            event.preventDefault();
            
            const dataTransfer = event.dataTransfer;
            const data = dataTransfer.getData("text/plain");

            try {
                const parsedData = JSON.parse(data);

                if (parsedData && parsedData.type) {
                    console.log("Dropped FoundryVTT item:", parsedData);

                    // Use the UUID to retrieve the item from Foundry VTT
                    const uuid = parsedData.uuid;
                    let item;

                    // Use the UUID to get the item from the FoundryVTT database
                    item = await fromUuid(uuid);

                    if (item) {
                        console.log(`Detailed ${parsedData.type} information:`, item);
                        
                        // Extract the image path
                        const imgPath = item.img;

                        // Load the image into miniPaint as a new layer
                        if (imgPath) {
                            const iframeDoc = iframe.contentWindow.document;
                            const miniPaint = iframe.contentWindow;
                            const Layers = miniPaint.Layers;

                            // Create a new Image object and load it
                            const image = new Image();
                            image.src = imgPath;

                            image.onload = () => {
                                const new_layer = {
                                    name: item.name,
                                    type: 'image',
                                    data: image,
                                    width: image.naturalWidth || image.width,
                                    height: image.naturalHeight || image.height,
                                    width_original: image.naturalWidth || image.width,
                                    height_original: image.naturalHeight || image.height,
                                };
                                Layers.insert(new_layer);
                                console.log("Image added to canvas as a new layer.");
                            };

                            image.onerror = () => {
                                console.error("Failed to load the image.");
                            };
                        } else {
                            console.error("No image path found in the item.");
                        }
                    } else {
                        console.log(`Could not retrieve the detailed information for ${parsedData.type}.`);
                    }
                }
            } catch (err) {
                console.log("Non-JSON data dropped, likely not a FoundryVTT item.");
            }
        });
    }
}

// Attach an event listener to the iframe to run the function once it's loaded
document.getElementById('myFrame').addEventListener('load', attachDropEventListener);


</script>
